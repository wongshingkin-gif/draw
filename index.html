<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœ¨ è¶…ç´šå¹¸é‹æŠ½ç±¤ 3.0</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6c5ce7">
    <link rel="apple-touch-icon" href="draw.png">
    
    <style>
        :root {
            --primary: #6c5ce7;
            --primary-dark: #5b4bc4;
            --secondary: #a29bfe;
            --accent: #ff7675;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass: rgba(255, 255, 255, 0.95);
        }

        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Segoe UI', sans-serif;
            background: var(--bg-gradient);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            background: var(--glass);
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 550px;
            text-align: center;
            position: relative;
            backdrop-filter: blur(10px);
            box-sizing: border-box;
            margin: 20px 0;
        }

        h1 { color: var(--primary-dark); margin: 0 0 1.5rem 0; font-size: 1.8rem; }

        .tabs { display: flex; background: #f1f2f6; border-radius: 12px; padding: 5px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: #7f8c8d; transition: all 0.3s ease; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .input-section { display: none; animation: fadeIn 0.3s; }
        .input-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .control-panel { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 12px; padding: 15px; margin-bottom: 15px; text-align: left; }
        
        select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ced6e0; margin-bottom: 10px; font-size: 1rem; }
        input[type="number"], textarea { width: 100%; padding: 12px; border: 2px solid #dfe6e9; border-radius: 10px; box-sizing: border-box; font-size: 1rem; }
        textarea { height: 100px; resize: vertical; }

        .settings-bar { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; font-size: 0.95rem; color: #636e72; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }

        .action-area { display: flex; gap: 10px; margin-top: 20px; }
        button.main-btn { flex: 2; padding: 15px; border: none; border-radius: 12px; font-size: 1.2rem; font-weight: bold; color: white; background: var(--primary); cursor: pointer; transition: transform 0.1s; }
        button.main-btn:active { transform: scale(0.96); }
        button.reset-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; background: #dfe6e9; color: #636e72; font-weight: bold; cursor: pointer; }

        #result-box { margin-top: 25px; min-height: 120px; display: flex; justify-content: center; align-items: center; background: #f1f2f6; border-radius: 15px; position: relative; overflow: hidden; }
        #result-text { font-size: 3rem; font-weight: 800; color: var(--text); z-index: 2; word-break: break-word; padding: 10px; line-height: 1.1; }
        .rolling { animation: pulse 0.1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }
        .winner-anim { color: var(--accent) !important; animation: popIn 0.5s forwards; }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
        .status-msg { font-size: 0.9rem; margin-bottom: 10px; display: block; font-weight: bold;}
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<div class="container">
    <h1>ğŸ€ å¹¸é‹æŠ½ç±¤</h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('number')">ğŸ”¢ æ•¸å­—æ¨¡å¼</button>
        <button class="tab-btn" onclick="switchTab('name')">ğŸ“ å§“åæ¨¡å¼</button>
    </div>

    <div id="section-number" class="input-section active">
        <div class="control-panel">
            <div style="display: flex; gap: 10px;">
                <div style="flex:1;"><label>æœ€å°</label><input type="number" id="minNum" value="1"></div>
                <div style="flex:1;"><label>æœ€å¤§</label><input type="number" id="maxNum" value="30"></div>
            </div>
        </div>
    </div>

    <div id="section-name" class="input-section">
        <div class="control-panel">
            <span id="syncStatus" class="status-msg">â³ æ­£åœ¨è¼‰å…¥åå–®...</span>
            
            <select id="groupSelect" onchange="changeGroup()">
                <option value="">è¼‰å…¥ä¸­...</option>
            </select>
            
            <textarea id="nameList" placeholder="åå–®æœƒé¡¯ç¤ºåœ¨é€™è£¡ï¼Œæ‚¨ä¹Ÿå¯ä»¥æ‰‹å‹•ä¿®æ”¹"></textarea>
        </div>
    </div>

    <div class="settings-bar">
        <div style="display:flex; align-items: center; gap: 10px;">
            <label class="switch">
                <input type="checkbox" id="removeAfterDraw">
                <span class="slider"></span>
            </label>
            <span>æŠ½å¾Œç§»é™¤ (ä¸é‡è¤‡)</span>
        </div>
        <div id="pool-status" style="font-weight: bold; color: var(--primary);">å¾…æŠ½: 0</div>
    </div>

    <div class="action-area">
        <button class="reset-btn" onclick="resetPool(true)">ğŸ”„ é‡ç½®</button>
        <button class="main-btn" onclick="startDraw()" id="drawBtn">é–‹å§‹æŠ½ç±¤ï¼</button>
    </div>

    <div id="result-box">
        <div id="result-text" style="color:#dfe6e9; font-size: 1.5rem;">æº–å‚™å°±ç·’</div>
    </div>
</div>

<script>
    // --- è¨»å†Š Service Worker (PWA æ ¸å¿ƒ) ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .catch(err => console.log('ServiceWorker è¨»å†Šå¤±æ•—: ', err));
        });
    }

    // ==========================================
    // ğŸ‘‡ è«‹å°‡ä½ çš„ Apps Script ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€è²¼åœ¨é€™è£¡ ğŸ‘‡
    // ==========================================
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbznZ_6tmprlYgMLMxmJao3G857ecSlcxgu5II343nqoJJVbCdLR2HD7n5C3vldhGpfc/exec';
    // ==========================================

    let currentMode = 'number';
    let currentPool = [];
    let isRolling = false;
    let sheetGroups = {};

    window.onload = () => {
        fetchSheetData();
        resetPool(true);
    };

    function switchTab(mode) {
        currentMode = mode;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.input-section').forEach(sec => sec.classList.remove('active'));
        
        const btnIndex = mode === 'number' ? 0 : 1;
        document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
        document.getElementById(`section-${mode}`).classList.add('active');
        
        resetPool(true);
    }

    async function fetchSheetData() {
        const statusSpan = document.getElementById('syncStatus');
        
        if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === 'è«‹è²¼ä¸Šä½ çš„_APP_SCRIPT_ç¶²å€') {
            statusSpan.innerText = "âš ï¸ è«‹åœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®š Apps Script ç¶²å€ï¼";
            statusSpan.style.color = "#d63031";
            document.getElementById('groupSelect').innerHTML = '<option value="">è«‹è¨­å®šç¶²å€</option>';
            return;
        }

        statusSpan.innerText = "â³ è¼‰å…¥åå–®ä¸­...";
        statusSpan.style.color = "#0984e3";

        try {
            const response = await fetch(APPS_SCRIPT_URL);
            if (!response.ok) throw new Error('ç¶²è·¯å›æ‡‰éŒ¯èª¤');
            
            // ç›´æ¥å°‡ Apps Script å›å‚³çš„ JSON è½‰ç‚ºç‰©ä»¶
            sheetGroups = await response.json(); 
            
            updateGroupSelect();
            
            statusSpan.innerText = "âœ… Google Sheet åå–®è¼‰å…¥æˆåŠŸï¼";
            statusSpan.style.color = "#00b894";
        } catch (error) {
            statusSpan.innerText = "âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²å€åŠ Apps Script æ¬Šé™è¨­å®šã€‚";
            statusSpan.style.color = "#d63031";
            console.error(error);
        }
    }

    // æ›´æ–°ä¸‹æ‹‰é¸å–®
    function updateGroupSelect() {
        const select = document.getElementById('groupSelect');
        select.innerHTML = '';
        Object.keys(sheetGroups).forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.text = `${key} (${sheetGroups[key].length}äºº)`;
            select.appendChild(option);
        });
        changeGroup();
    }

    function changeGroup() {
        const selectedGroup = document.getElementById('groupSelect').value;
        if (sheetGroups[selectedGroup]) {
            document.getElementById('nameList').value = sheetGroups[selectedGroup].join('\n');
            resetPool(true);
        }
    }

    document.getElementById('nameList').addEventListener('input', () => {
        if (!document.getElementById('removeAfterDraw').checked) {
            resetPool(false);
        }
    });

    function resetPool(fullReset = false) {
        currentPool = [];
        if (currentMode === 'number') {
            const min = parseInt(document.getElementById('minNum').value) || 1;
            const max = parseInt(document.getElementById('maxNum').value) || 10;
            if (max >= min) {
                for (let i = min; i <= max; i++) currentPool.push(i);
            }
        } else {
            const text = document.getElementById('nameList').value;
            currentPool = text.split('\n').map(s => s.trim()).filter(s => s !== "");
        }
        
        document.getElementById('pool-status').innerText = `å¾…æŠ½: ${currentPool.length}`;
        
        if(fullReset) {
            const resultDiv = document.getElementById('result-text');
            resultDiv.innerText = "æº–å‚™å°±ç·’";
            resultDiv.className = "";
            resultDiv.style.color = "#dfe6e9";
            resultDiv.style.fontSize = "1.5rem";
        }
    }

    function startDraw() {
        if (isRolling) return;
        const removeAfter = document.getElementById('removeAfterDraw').checked;

        if (currentPool.length === 0) {
            alert("æŠ½çæ± æ˜¯ç©ºçš„ï¼è«‹å…ˆæŒ‰ã€Œé‡ç½®ã€æˆ–æª¢æŸ¥åå–®ã€‚");
            return;
        }

        isRolling = true;
        const btn = document.getElementById('drawBtn');
        const resultDiv = document.getElementById('result-text');
        
        btn.disabled = true;
        resultDiv.className = "rolling";
        resultDiv.style.color = "#a29bfe";
        resultDiv.style.fontSize = "3rem";

        const totalTime = 1500; 
        const interval = setInterval(() => {
            const r = Math.floor(Math.random() * currentPool.length);
            resultDiv.innerText = currentPool[r];
        }, 50);

        setTimeout(() => {
            clearInterval(interval);
            const winnerIndex = Math.floor(Math.random() * currentPool.length);
            const winner = currentPool[winnerIndex];

            resultDiv.innerText = winner;
            resultDiv.className = "winner-anim";
            fireConfetti();

            if (removeAfter) {
                currentPool.splice(winnerIndex, 1);
                document.getElementById('pool-status').innerText = `å¾…æŠ½: ${currentPool.length}`;
            }

            isRolling = false;
            btn.disabled = false;
        }, totalTime);
    }

    function fireConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        let particles = [];
        const colors = ['#ff7675', '#74b9ff', '#55efc4', '#fdcb6e', '#a29bfe'];
        
        for(let i=0; i<100; i++) {
            particles.push({
                x: window.innerWidth / 2, y: window.innerHeight / 2,
                vx: (Math.random() - 0.5) * 15, vy: (Math.random() - 0.5) * 15,
                life: 100, color: colors[Math.floor(Math.random() * colors.length)],
                size: Math.random() * 8 + 4
            });
        }

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let active = false;
            particles.forEach(p => {
                if(p.life > 0) {
                    active = true;
                    p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life--;
                    ctx.fillStyle = p.color; ctx.globalAlpha = p.life / 100;
                    ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();
                }
            });
            if(active) requestAnimationFrame(render);
            else ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        render();
    }
</script>
</body>
</html>
